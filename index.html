<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knee4CTB AI Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .chat-header p {
            font-size: 14px;
            opacity: 0.9;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 80%;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: #667eea;
            color: white;
        }

        .message.assistant .message-avatar {
            background: #e8eaf6;
            color: #667eea;
        }

        .message-content {
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 15px;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-content {
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .chat-input-container {
            padding: 20px;
            border-top: 1px solid #e0e0e0;
            background: white;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 24px;
            font-size: 15px;
            resize: none;
            font-family: inherit;
            max-height: 120px;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
        }

        .send-button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 12px;
        }

        .quick-action-btn {
            padding: 8px 16px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .quick-action-btn:hover {
            background: #667eea;
            color: white;
        }

        .disclaimer {
            padding: 12px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            margin-bottom: 16px;
            font-size: 13px;
            color: #856404;
            border-radius: 4px;
        }

        .disclaimer strong {
            display: block;
            margin-bottom: 4px;
        }

        /* Scrollbar styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <h1>ü¶µ Knee4CTB AI Assistant</h1>
            <p>Get personalized knee rehabilitation guidance</p>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <div class="disclaimer">
                <strong>‚ö†Ô∏è Medical Disclaimer</strong>
                This chatbot provides educational information only and is not a substitute for professional medical advice, diagnosis, or treatment. Always seek the advice of your physician or qualified healthcare provider with questions about a medical condition.
            </div>
            <div class="message assistant">
                <div class="message-avatar">ü§ñ</div>
                <div>
                    <div class="message-content">
                        Hello! I'm your Knee4CTB AI assistant. I'm here to help you understand knee injuries and guide you through rehabilitation. 
                        <br><br>
                        I can help you with:
                        <br>‚Ä¢ Answering questions about knee rehabilitation
                        <br>‚Ä¢ Discussing the 12 common knee injuries we cover
                        <br>‚Ä¢ Helping diagnose unusual injuries that don't fit our standard categories
                        <br>‚Ä¢ Explaining treatment and recovery processes
                        <br><br>
                        What brings you here today?
                    </div>
                    <div class="quick-actions">
                        <button class="quick-action-btn" onclick="sendQuickMessage('I have knee pain and need help identifying my injury')">Identify my injury</button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('Tell me about the 12 types of knee injuries you cover')">Learn about injuries</button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('What exercises can help with knee rehabilitation?')">Rehabilitation exercises</button>
                        <button class="quick-action-btn" onclick="sendQuickMessage('What is the golden hour in knee rehabilitation?')">Golden hour concept</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-input-container">
            <div class="chat-input-wrapper">
                <textarea 
                    id="userInput" 
                    class="chat-input" 
                    placeholder="Type your question here..."
                    rows="1"
                ></textarea>
                <button id="sendButton" class="send-button" onclick="sendMessage()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        // This will be updated to your Netlify function URL after deployment
        // Format: https://YOUR-SITE-NAME.netlify.app/.netlify/functions/chat
        const API_URL = '/.netlify/functions/chat';
        
        // System prompt with all the knee injury knowledge
        const SYSTEM_PROMPT = `You are a specialized AI assistant for Knee4CTB, a knee rehabilitation guidance platform created by YK Pao School students. Your role is to help patients understand knee injuries and guide them through rehabilitation.

DETAILED INFORMATION ABOUT THE 12 KNEE INJURIES:

ACUTE INJURIES (Sudden onset):

1. ACL TEAR (Anterior Cruciate Ligament)
WHAT IT IS: Disruption of the primary anterior stabilizer of the knee, preventing anterior translation of the tibia. Often involves a non-contact pivoting mechanism, audible "pop," hemarthrosis (blood in joint), and immediate instability.
IMMEDIATE TREATMENT: Stop all activity and lie down with leg elevated to 30 degrees (knee and ankle above heart). Do not weight-bear‚Äîuse crutches. Apply ice for 20 minutes and wrap with compression bandage. Must see doctor within 1-2 days to rule out fractures or additional ligament tears.
DEFINITIVE: Requires orthopedic evaluation. Surgery vs. rehabilitation based on patient's age, activity level, and associated injuries.

2. PATELLA DISLOCATION
WHAT IT IS: Lateral displacement of the patella from the trochlear groove of the femur. Presents with dramatic deformity, severe pain, and knee held in flexion.
IMMEDIATE TREATMENT: If kneecap still out of place‚Äîdo NOT move joint, keep slightly bent, immobilize with splint, go to ER immediately. If already popped back‚Äîgently straighten leg, immobilize straight, apply ice to inner side, compress, elevate, see doctor promptly.
AFTER REDUCTION: Immobilization in knee brace for 2-3 weeks, then PT for VMO strengthening.

3. MCL TEAR (Medial Collateral Ligament)
WHAT IT IS: Injury to the primary valgus stabilizer, graded I-III. Caused by direct blow to lateral knee. Pain localized to medial joint line.
IMMEDIATE TREATMENT: Stop, sit/lie down, gently straighten knee. Avoid knock-kneed posture. Place pillow under outer ankle/calf to tilt leg outward, taking tension off inner ligament. Ice inner knee, compress, use crutches.
TREATMENT: Grade I-II heal with bracing and PT. Grade III may need 4-6 weeks bracing. High healing potential, rarely requires surgery.

4. LCL TEAR (Lateral Collateral Ligament)
WHAT IT IS: Injury to primary varus stabilizer. Less common, often associated with posterolateral corner injuries.
IMMEDIATE TREATMENT: Stop and bend knee to 20-30 degrees (slight bend). Place pillow under inner ankle/calf to tilt knee inward. CHECK FOR NERVE INJURY‚Äîif cannot pull toes/foot upward (foot drop) or numbness, seek emergency care immediately. Ice outer knee, use crutches.
TREATMENT: Requires thorough evaluation. Grade III or combined injuries often need surgery.

5. PCL TEAR (Posterior Cruciate Ligament)
WHAT IT IS: Disruption of restraint to posterior tibial translation, often from dashboard injury. Presents with posterior knee pain and mild effusion.
IMMEDIATE TREATMENT: Lie on back with firm pillow under calf (just below knee) to hold shinbone forward. Keep knee bent 20-30 degrees. Do NOT place support under heel or knee. Non-weight-bearing, use crutches. Ice back of knee.
TREATMENT: Most isolated tears treated non-operatively with bracing and quadriceps strengthening.

6. MENISCUS TEAR (Acute)
WHAT IT IS: Tear in fibrocartilaginous meniscus. Traumatic tears are vertical/longitudinal. Presents with joint line pain, effusion, and mechanical symptoms (locking, catching).
IMMEDIATE TREATMENT: Stop and gently straighten knee without forcing. If locked‚Äîdo NOT force, keep comfortable, use crutches. If can straighten‚Äîhold straight with pillow under heel. Ice, compress, elevate, non-weight-bearing.
TREATMENT: PT first-line for degenerative tears. Surgery if mechanical locking persists.

7. TIBIAL PLATEAU FRACTURE
WHAT IT IS: Intra-articular fracture of proximal tibia, disrupting weight-bearing surface. Orthopedic emergency.
IMMEDIATE TREATMENT: Call ambulance immediately. Do NOT move or weight-bear. This prevents bone displacement and vascular injury.
TREATMENT: Emergency orthopedic care required.

CHRONIC INJURIES (Gradual onset):

8. MENISCUS TEAR (Chronic)
(Same as acute meniscus tear info above)

9. PATELLOFEMORAL PAIN SYNDROME (Runner's Knee)
WHAT IT IS: Anterior knee pain from patellofemoral joint, attributed to abnormal tracking, muscular imbalances, or overload. Pain aggravated by stairs, squatting, prolonged sitting.
IMMEDIATE TREATMENT: Stop painful activity. Keep leg fully extended/straight when resting. Avoid sitting with knee bent beyond 90 degrees. Ice front and sides of kneecap for 15-20 minutes.
TREATMENT: Rest from loading in bent position, then correct muscle imbalances and tracking issues.

10. PATELLAR TENDINOPATHY (Jumper's Knee)
WHAT IT IS: Tendinosis (degenerative) of patellar tendon at inferior pole. Involves collagen disorganization. Pain during and after loading.
IMMEDIATE TREATMENT: Stop aggravating activity (jumping, running, squatting). Sit with foot flat, knee slightly bent. Can walk but avoid stairs/hills/deep squats. Ice base of kneecap for 15-20 minutes.
TREATMENT: Eccentric strengthening exercises (slow squats on decline board) to remodel tendon.

11. ILIOTIBIAL BAND SYNDROME
WHAT IT IS: Overuse/friction syndrome where IT band rubs against lateral femoral epicondyle. Pain on lateral knee.
IMMEDIATE TREATMENT: Stop activity. Lie on unaffected side, draw affected leg backward (hip extension) to stretch IT band. Ice outer knee for 15 minutes. Foam roll side of thigh.
TREATMENT: IT band/gluteal stretching, foam rolling, hip abductor strengthening.

12. KNEE BURSITIS
WHAT IT IS: Inflammation of synovial fluid-filled bursae. Prepatellar bursitis (housemaid's knee) and pes anserine bursitis are common.
IMMEDIATE TREATMENT: Avoid direct pressure on swollen area. If prepatellar‚Äîkeep leg straight. If pes anserine‚Äîknee slightly bent with pillow under calf. Ice for 15-20 minutes. CHECK FOR INFECTION‚Äîif very red, hot, and fever, seek medical care immediately (septic bursitis).
TREATMENT: Rest, ice, anti-inflammatories. Antibiotics if infected.

13. KNEE OSTEOARTHRITIS
WHAT IT IS: Degenerative joint disease with progressive cartilage loss, subchondral sclerosis, osteophyte formation, and synovitis.
IMMEDIATE TREATMENT: During flare‚Äîminimize joint pressure. Prop leg up, keep knee straight or slightly bent. Avoid deep bending and prolonged standing. Ice swollen areas for 15-20 minutes. For morning stiffness‚Äîwarm shower or gentle range-of-motion exercises.
TREATMENT: Short-term rest, then gentle regular movement (walking, swimming)

DIAGNOSIS TREE STRUCTURE:
Q1: How did injury start? ‚Üí Sudden (Acute) or Gradual (Chronic)
Q2 (Acute): Heard a pop? ‚Üí Yes (Q3) or No (Q4)
Q3: Where did knee move? ‚Üí Out then back (Patella) or Shifted/grooved (ACL)
Q4: Can walk 4 steps? ‚Üí No (Tibial Plateau) or Yes but hurts (Q5)
Q5: Where hurts with pressure? ‚Üí Inner (MCL) / Outer (LCL) / Bone line (Meniscus) / None (refer to AI)
Q6 (Chronic): Knee gets stuck? ‚Üí Yes (Meniscus) or No (Q7)
Q7: When hurts most? ‚Üí After sitting/stairs (Runner's) / Morning stiff (Osteoarthritis) / Jumping (Patellar) / Constant (Q8) / Training (IT Band)
Q8: Visible lump? ‚Üí Yes (Bursitis) or No (refer to AI)

FOR INJURIES NOT FITTING THE 12 CATEGORIES:
You have extensive medical knowledge beyond these 12 injuries. When a patient's symptoms don't match the standard categories, systematically assess:

OTHER KNEE CONDITIONS TO CONSIDER:
- Plica Syndrome (painful snapping band of tissue)
- Osteochondritis Dissecans (cartilage and bone fragment loose in joint)
- Hoffa's Fat Pad Impingement (sharp anterior pain)
- Baker's Cyst (posterior knee swelling)
- Prepatellar Bursitis variants
- Pes Anserine Bursitis
- Stress fractures
- Osgood-Schlatter Disease (in adolescents)
- Sinding-Larsen-Johansson Syndrome
- Quadriceps tendinopathy
- Medial plica irritation
- Synovial chondromatosis
- Gout/pseudogout (inflammatory arthritis)
- Referred pain from hip or lumbar spine

DIAGNOSTIC APPROACH FOR UNUSUAL CASES:
1. Onset: Sudden trauma vs. gradual overuse vs. no clear cause?
2. Location: Anterior, medial, lateral, posterior, or diffuse?
3. Character: Sharp, dull, aching, burning, catching, locking, giving way?
4. Timing: Constant, intermittent, morning stiffness, after activity, during activity?
5. Aggravating factors: Stairs (up/down), squatting, running, jumping, sitting, standing?
6. Associated symptoms: Swelling, redness, warmth, clicking, popping, instability?
7. Age/activity: Adolescent (consider growth plate issues), athletic (overuse), elderly (degenerative)?
8. Previous injuries or surgeries?
9. Systemic symptoms: Fever (infection?), multiple joint pain (inflammatory arthritis?)?

Ask targeted follow-up questions to narrow differential diagnosis. Provide patient with likely possibilities and emphasize need for professional evaluation.

THE GOLDEN HOUR CONCEPT:
The "golden hour" refers to the critical initial period after a knee injury where proper immediate action can significantly improve recovery outcomes. Taking the right steps quickly helps reduce inflammation, prevent further damage, and set the foundation for effective rehabilitation.

YOUR RESPONSIBILITIES:
1. Answer questions about knee injuries, symptoms, and rehabilitation
2. For standard injuries‚Äîreference the diagnostic tree and detailed treatment protocols
3. For unusual injuries‚Äîuse your medical knowledge to help narrow the diagnosis by asking systematic questions
4. Provide evidence-based immediate treatment advice appropriate to the suspected condition
5. Guide patients through understanding their condition
6. Emphasize the importance of professional medical evaluation
7. Provide information about rehabilitation exercises and recovery timelines when appropriate
8. Be empathetic and supportive - knee injuries can be frustrating and painful

IMPORTANT GUIDELINES:
- Always remind patients this is educational information, not a diagnosis
- Encourage seeing a healthcare professional for proper evaluation
- Be thorough in asking about symptoms when helping diagnose unusual cases
- Use clear, non-technical language when possible, but explain medical terms when needed
- Be supportive and encouraging about recovery prospects
- If symptoms suggest serious condition (severe pain, inability to bear weight, signs of fracture, suspected infection), urge immediate medical attention
- For unusual presentations, provide differential diagnosis (possible conditions) rather than single diagnosis

Keep responses concise but informative. Use a warm, professional tone.`;

        let conversationHistory = [];
        
        // Auto-resize textarea
        const userInput = document.getElementById('userInput');
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 120) + 'px';
        });
        
        // Send message on Enter (Shift+Enter for new line)
        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        function sendQuickMessage(message) {
            userInput.value = message;
            sendMessage();
        }
        
        async function sendMessage() {
            const input = document.getElementById('userInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Add user message to chat
            addMessage(message, 'user');
            input.value = '';
            input.style.height = 'auto';
            
            // Disable input while processing
            const sendButton = document.getElementById('sendButton');
            input.disabled = true;
            sendButton.disabled = true;
            
            // Show typing indicator
            showTypingIndicator();
            
            // Add to conversation history
            conversationHistory.push({
                role: 'user',
                content: message
            });
            
            try {
                // Call our Netlify function (which then calls Anthropic API)
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        system: SYSTEM_PROMPT,
                        messages: conversationHistory
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                removeTypingIndicator();
                
                if (data.content && data.content[0] && data.content[0].text) {
                    const assistantMessage = data.content[0].text;
                    
                    // Add to conversation history
                    conversationHistory.push({
                        role: 'assistant',
                        content: assistantMessage
                    });
                    
                    // Add assistant message to chat
                    addMessage(assistantMessage, 'assistant');
                } else {
                    addMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                }
                
            } catch (error) {
                console.error('Error:', error);
                removeTypingIndicator();
                addMessage('Sorry, I\'m having trouble connecting. Please make sure you have an active internet connection and try again.', 'assistant');
            }
            
            // Re-enable input
            input.disabled = false;
            sendButton.disabled = false;
            input.focus();
        }
        
        function addMessage(text, sender) {
            const messagesContainer = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'user' ? 'üë§' : 'ü§ñ';
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = formatMessage(text);
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function formatMessage(text) {
            // Convert markdown-style formatting to HTML
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/\n/g, '<br>');
        }
        
        function showTypingIndicator() {
            const messagesContainer = document.getElementById('chatMessages');
            
            const typingDiv = document.createElement('div');
            typingDiv.className = 'message assistant';
            typingDiv.id = 'typingIndicator';
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ü§ñ';
            
            const indicatorDiv = document.createElement('div');
            indicatorDiv.className = 'message-content';
            
            const dotsDiv = document.createElement('div');
            dotsDiv.className = 'typing-indicator';
            dotsDiv.innerHTML = '<div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>';
            
            indicatorDiv.appendChild(dotsDiv);
            typingDiv.appendChild(avatar);
            typingDiv.appendChild(indicatorDiv);
            
            messagesContainer.appendChild(typingDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        function removeTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }
    </script>
</body>
</html>
